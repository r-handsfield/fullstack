"use strict";define("bundles/assess/assessmentTypes/phoenixQuiz/assessment",["require","exports","module","jquery","moment","underscore","bundles/assess/assessmentTypes/phoenixQuiz/assessment.exam.html","bundles/assess/assessmentTypes/phoenixQuiz/assessment.quiz.html","bundles/ondemand/appContextSingleton","bundles/ondemand/components/LockingCover","bundles/ondemand/components/assignments/AssignmentHonorCode","bundles/ondemand/stores/CourseScheduleStore","bundles/ondemand/stores/ProgressStore","bundles/ondemand/stores/SessionStore","bundles/ondemand/utils/assignmentVerificationTest","bundles/ondemand/utils/penaltiesExperiment","bundles/page/lib/metatagsAddressBook","bundles/phoenix/components/TimeDuration","bundles/phoenix/lib/view","bundles/phoenix/template/models/userAuthorization","bundles/phoenix/template/models/userIdentity","js/lib/modals","js/lib/pluralize","pages/open-course/assessment/models/relativePassingStates","pages/open-course/common/utils/ensureEnrolled","pages/open-course/common/views/performanceBar","js/lib/tooltips"],function(require,exports,module){var $=require("jquery"),n=require("moment"),_=require("underscore"),h=require("bundles/assess/assessmentTypes/phoenixQuiz/assessment.exam.html"),x=require("bundles/assess/assessmentTypes/phoenixQuiz/assessment.quiz.html"),l=require("bundles/ondemand/appContextSingleton"),c=require("bundles/ondemand/components/LockingCover"),i=require("bundles/ondemand/components/assignments/AssignmentHonorCode"),o=require("bundles/ondemand/stores/CourseScheduleStore"),y=require("bundles/ondemand/stores/ProgressStore"),t=require("bundles/ondemand/stores/SessionStore"),r=require("bundles/ondemand/utils/assignmentVerificationTest"),m=r.inHonorCodeVariant,u=require("bundles/ondemand/utils/penaltiesExperiment"),k=require("bundles/page/lib/metatagsAddressBook"),s=require("bundles/phoenix/components/TimeDuration"),p=require("bundles/phoenix/lib/view"),g=require("bundles/phoenix/template/models/userAuthorization"),b=require("bundles/phoenix/template/models/userIdentity"),a=require("js/lib/modals"),v=require("js/lib/pluralize"),S=require("pages/open-course/assessment/models/relativePassingStates"),d=require("pages/open-course/common/utils/ensureEnrolled"),C=require("pages/open-course/common/views/performanceBar");require("js/lib/tooltips");var e=function getMetadata(e){return function(){return this.model.get("metadata").get(e)}},f=p.extend({name:"itemView",bodyClasses:"c-item-assessment",multitracker:{namespace:"open_course.item_page.quiz",baseValues:["open_course_slug","module_id","module_name","lesson_id","lesson_name","item_id","item_name"],definitions:{open_course_slug:e("course.slug"),module_id:e("lesson.module.id"),module_name:e("lesson.module.name"),lesson_id:e("lesson.id"),lesson_name:e("lesson.name"),item_id:e("id"),item_name:e("name")},events:{start:[],resume:[]},eventingVersion:2},events:{'click [data-js~="start-button"]':"start",'click [data-js~="retake-button"]':"start",'click [data-js~="review-button"]':"review",'click [data-js~="confirm-start-button"]':"confirmedStart",'click [data-js~="stay-button"]':"closeModal"},initialize:function initialize(e){$("body").addClass(this.bodyClasses),_.bindAll(this,"confirmedStart"),this.onStateChange=e.onStateChange,this.verificationDisplay=e.verificationDisplay,this.itemGrade=e.itemGrade,this.courseSlug=this.model.get("metadata.course.slug"),this.moduleNumber=this.model.get("metadata.lesson.module.index"),this.authenticated=b.get("authenticated"),this.isVerificationEnabled=this.model.get("metadata.course").isVerificationEnabled(),this.initializePerformanceBar(),this.on("view:closing",this.onClose,this),k.setMetatags({pageName:"title-and-description",context:{title:this.model.get("metadata.name"),description:this.model.get("metadata.lesson.module.description")},options:{imageHref:this.model.get("metadata.course.promoPhoto")}})},initializePerformanceBar:function initializePerformanceBar(){var e=this.model.getDisplayEvaluation(this.verificationDisplay);this.authenticated&&e&&(this.performanceBar=new C({evaluation:e,showValue:!1,disableTransitions:!0}))},onClose:function onClose(){$("body").removeClass(this.bodyClasses)},closeModal:function closeModal(){if(!this.modal)return;this.modal.close(),this.modal=null},startQuiz:function startQuiz(){"exam"===this.model.get("metadata").getTypeName()&&this.model.isLastAttemptBeforeLock()?(this.closeModal(),t.isSessionsEnabled()?this.modal=a(this.$$("last-attempt-session-modal")):this.modal=a(this.$$("last-attempt-ondemand-modal")),this.modal.open()):this.confirmedStart()},start:function start(){if(!g.ensureAuthenticated())return null;d().then(this.startQuiz.bind(this)).fail(function(e){if(!(e instanceof d.UserRejectedEnrollPromptException))throw e}).done()},confirmedStart:function confirmedStart(){this.closeModal(),this.model.hasUnsubmittedAttempt()?this.track("resume"):this.track("start");var e=this.model.get("metadata"),t=e.isPremiumGradingLocked();if("exam"===e.getTypeName()&&this.verificationDisplay.get("isProductVerificationEnabled")&&!t){var s=this.model.get("metadata.id");this.showHonorCode=m()&&!i.hasAcceptedHonorCode(s),this.showHonorCode?this.render():this.openVerificationModule()}else this.onStateChange("attempt")},openVerificationModule:function openVerificationModule(){this.onStateChange("verify")},review:function review(){this.onStateChange("attempt",{attemptIndex:this.model.getLastSubmittedAttempt()})},render:function render(){var i=x;"exam"===this.model.get("metadata").getTypeName()&&(i=h);var r=this.model.getDisplayEvaluation(this.verificationDisplay),p=this.model.getRelativePassingState(this.verificationDisplay),s={model:this.model,pluralize:v,moment:n,authenticated:this.authenticated,evaluation:r,relativePassingState:p,relativePassingStates:S,showHonorCode:this.showHonorCode};if(t.isEnrolled()){var d=this.model.get("metadata.lesson.module.id"),m=l.getComponentContext(),c=m.getStore("CourseScheduleStore"),e=c.getDeadlineForModuleId(d),a=this.model.get("bestEvaluation")&&this.model.get("bestEvaluation").getHumanPercentScore(),g=this.model.get("bestSessionId")?new Date(parseInt(this.model.get("bestSessionId").split("~")[1],10)):null;_(s).extend({enrolledInSession:!0,deadline:o.getFormattedDeadline(e),hasDeadlinePassed:n().isAfter(e),courseDeadline:o.getFormattedDeadline(t.getEndDate()),bestScore:a,penalizedScore:y.getPenalizedScore(e,g,a),penaltiesEnabled:u()})}return this.$el.html(i(s)),this.renderSubviews(),this.renderRetakeButton(),this.authenticated&&this.model.hasSubmittedAttempt()&&this.model.examIsLocked&&this.model.examIsLocked()&&this.track("time_lock.render"),this},renderSubviews:function renderSubviews(){if(this.showHonorCode&&this.renderReactInto(i,"AssignmentHonorCode",{onHonorCodeAccept:this.openVerificationModule.bind(this),itemId:this.model.get("metadata.id")}),this.performanceBar&&this.$$("performance-bar-container").html(this.performanceBar.render().el),this.model.get("metadata").isLocked()&&this.renderReactInto(c,"LockingCover",{itemMetadata:this.model.get("metadata")}),"exam"===this.model.get("metadata").getTypeName()){var t=this.model.get("metadata").getDefinition("lockingConfiguration"),n=1===t.allowedSubmissionsPerInterval,e=t.allowedSubmissionsInterval,o=this.model.get("locksIfSubmittedBefore")-Date.now(),a=n?e:o;this.renderReactIntoAll(s,"FullIntervalDisplay",{duration:e},void 0,!0),this.renderReactIntoAll(s,"ShortIntervalDisplay",{duration:e,showNumberIfSingular:!1},void 0,!0),this.renderReactIntoAll(s,"RemainingIntervalDisplay",{duration:a,showNumberIfSingular:!1},void 0,!0)}},renderRetakeButton:function renderRetakeButton(){"exam"===this.model.get("metadata").getTypeName()&&this.$$("retake-button").attr("disabled",this.model.examIsLocked())}});module.exports=f});